# https://moonrepo.dev/docs/config/project
# yaml-language-server: $schema=https://moonrepo.dev/schemas/project.json
$schema: "https://moonrepo.dev/schemas/project.json"

type: application
language: go
toolchain:
  default: null
stack: backend
tags: ["app", "backend"]

# Overrides the name (identifier) of the project
id: "neatspace-backend"

project:
  name: "neatspace-backend"
  description: "_CHANGE_ME_DESCRIPTION_"

tasks:
  dev:
    command: "watchexec -r -e go,toml -w . --no-vcs-ignore -- go run -tags debug ./cmd/"
    args: ["serve"]
    deps: [kill-port]
    options:
      cache: false
      envFile: ".env"

  run:
    command: "go run -tags debug $projectRoot/cmd/"
    deps: [kill-port]
    options:
      cache: false
      interactive: true
      mergeOutputs: replace
      outputStyle: buffer
      mergeArgs: replace
      envFile: ".env"
  
  tidy:
    command: "go mod tidy"
    inputs:
      - "go.mod"
    outputs:
      - "go.sum"

  build:
    env:
      LDFLAGS_BUILD_HASH: "-X $project/internal.BuildHash=$vcsRevision"
      LDFLAGS_BUILD_DATE: "-X $project/internal.BuildDate=$datetime"
      LDFLAGS_STATIC: "-w -s -extldflags '-static'"
    script: |
      go build -tags prod -trimpath -buildmode=pie -buildvcs=false \
        --ldflags="$LDFLAGS_STATIC $LDFLAGS_BUILD_DATE $LDFLAGS_BUILD_HASH \
        -X $project/internal.Version=$(jq -r .version <$workspaceRoot'/package.json')" \
        -o $projectRoot/build/release/$project $projectRoot/cmd/
    deps: [tidy]
    options:
      mergeArgs: append
      envFile: ".env"

  start:
    command: "build/release/$project"
    args: ["serve"]
    deps: [kill-port]
    options:
      cache: false
      outputStyle: buffer
      mergeArgs: replace
      envFile: ".env"

  test:
    command: "gotestsum --format short-verbose --"
    args: ["-count=1", "-v", "./internal/...", "./pkg/..."]
    deps: ["tidy"]
    options:
      cache: false
      runFromWorkspaceRoot: false
      mergeOutputs: replace
      outputStyle: buffer
      mergeArgs: replace
      envFile: ".env"

  kill-port:
    command: "pnpm --package=kill-port-process-cli dlx kill-port 8080"
    deps: [tidy]
    options:
      envFile: ".env"
      internal: true
      outputStyle: none

  generate-swagger:
    command: "swag init -g cmd/main.go -o docs --parseDependency --parseInternal"
    inputs:
      - "cmd/**/*.go"
      - "internal/**/*.go"
    outputs:
      - "docs/swagger.json"
      - "docs/swagger.yaml"
      - "docs/docs.go"
    options:
      cache: true
      outputStyle: buffer-only-failure

  coverage:
    script: |
      gotestsum --format testname -- -coverprofile=build/coverage.out ./internal/... ./pkg/...
      go tool cover -html=$projectRoot/build/coverage.out -o $projectRoot/build/coverage.html
      go tool cover -func=$projectRoot/build/coverage.out | tail -1
    deps: ["tidy"]
    options:
      shell: true
      cache: false
      runFromWorkspaceRoot: false
      mergeOutputs: replace
      outputStyle: buffer
      mergeArgs: replace
      envFile: ".env"

  docker-build:
    script: |
      DOCKER_IMAGE="$(jq -r .name <./package.json)-$project" \
      DOCKER_IMAGE_VERSION="$(jq -r .version <./package.json)" \
      && docker build -f $projectRoot/Dockerfile . -t $DOCKER_IMAGE:$DOCKER_IMAGE_VERSION \
      && docker image list --filter reference=$DOCKER_IMAGE\*
    options:
      mergeEnv: replace
      runFromWorkspaceRoot: true
      interactive: false
      outputStyle: buffer-only-failure
      runInCI: false
      cache: false
      shell: true

  docker-run:
    script: |
      DOCKER_IMAGE="$(jq -r .name <./package.json)-$project" \
      DOCKER_IMAGE_VERSION="$(jq -r .version <./package.json)" \
      && docker run --network=host --rm -it --env-file $projectRoot/.env \
        --name $DOCKER_IMAGE $DOCKER_IMAGE:$DOCKER_IMAGE_VERSION
    options:
      mergeEnv: replace 
      outputStyle: buffer-only-failure
      runFromWorkspaceRoot: true
      interactive: false
      runInCI: false
      cache: false
      shell: true